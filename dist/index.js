"use strict";var H=Object.create;var g=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty;var j=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports),B=(i,t)=>{for(var e in t)g(i,e,{get:t[e],enumerable:!0})},w=(i,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of M(t))!U.call(i,r)&&r!==e&&g(i,r,{get:()=>t[r],enumerable:!(n=O(t,r))||n.enumerable});return i};var J=(i,t,e)=>(e=i!=null?H(K(i)):{},w(t||!i||!i.__esModule?g(e,"default",{value:i,enumerable:!0}):e,i)),$=i=>w(g({},"__esModule",{value:!0}),i);var P=j(l=>{"use strict";Object.defineProperty(l,"__esModule",{value:!0});l.decode=l.verify=l.sign=void 0;if(typeof crypto>"u"||!crypto.subtle)throw new Error("SubtleCrypto not supported!");function T(i){return new Uint8Array(Array.prototype.map.call(atob(i.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"")),t=>t.charCodeAt(0)))}function f(i){return btoa(String.fromCharCode.apply(0,i)).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}var A={ES256:{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}},ES384:{name:"ECDSA",namedCurve:"P-384",hash:{name:"SHA-384"}},ES512:{name:"ECDSA",namedCurve:"P-521",hash:{name:"SHA-512"}},HS256:{name:"HMAC",hash:{name:"SHA-256"}},HS384:{name:"HMAC",hash:{name:"SHA-384"}},HS512:{name:"HMAC",hash:{name:"SHA-512"}},RS256:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},RS384:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}},RS512:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}}};function d(i){return T(btoa(unescape(encodeURIComponent(i))))}function I(i){i=atob(i);let t=new ArrayBuffer(i.length),e=new Uint8Array(t);for(let n=0,r=i.length;n<r;n++)e[n]=i.charCodeAt(n);return t}function k(i){switch(i.length%4){case 0:break;case 2:i+="==";break;case 3:i+="=";break;default:throw new Error("Illegal base64url string!")}try{return JSON.parse(decodeURIComponent(escape(atob(i))))}catch{return null}}async function _(i,t,e={algorithm:"HS256",header:{typ:"JWT"}}){if(typeof e=="string"&&(e={algorithm:e,header:{typ:"JWT"}}),e={algorithm:"HS256",header:{typ:"JWT"},...e},i===null||typeof i!="object")throw new Error("payload must be an object");if(typeof t!="string"&&typeof t!="object")throw new Error("secret must be a string or a JWK object");if(typeof e.algorithm!="string")throw new Error("options.algorithm must be a string");let n=A[e.algorithm];if(!n)throw new Error("algorithm not found");i.iat||(i.iat=Math.floor(Date.now()/1e3));let r=JSON.stringify(i),a=`${f(d(JSON.stringify({...e.header,alg:e.algorithm})))}.${f(d(r))}`,p="raw",s;typeof t=="object"?(p="jwk",s=t):typeof t=="string"&&t.startsWith("-----BEGIN")?(p="pkcs8",s=I(t.replace(/-----BEGIN.*?-----/g,"").replace(/-----END.*?-----/g,"").replace(/\s/g,""))):s=d(t);let m=await crypto.subtle.importKey(p,s,n,!1,["sign"]),E=await crypto.subtle.sign(n,m,d(a));return`${a}.${f(new Uint8Array(E))}`}l.sign=_;async function x(i,t,e={algorithm:"HS256",throwError:!1}){if(typeof e=="string"&&(e={algorithm:e,throwError:!1}),e={algorithm:"HS256",throwError:!1,...e},typeof i!="string")throw new Error("token must be a string");if(typeof t!="string"&&typeof t!="object")throw new Error("secret must be a string or a JWK object");if(typeof e.algorithm!="string")throw new Error("options.algorithm must be a string");let n=i.split(".");if(n.length!==3)throw new Error("token must consist of 3 parts");let r=A[e.algorithm];if(!r)throw new Error("algorithm not found");let{payload:a}=y(i);if(!a){if(e.throwError)throw"PARSE_ERROR";return!1}if(a.nbf&&a.nbf>Math.floor(Date.now()/1e3)){if(e.throwError)throw"NOT_YET_VALID";return!1}if(a.exp&&a.exp<=Math.floor(Date.now()/1e3)){if(e.throwError)throw"EXPIRED";return!1}let p="raw",s;typeof t=="object"?(p="jwk",s=t):typeof t=="string"&&t.startsWith("-----BEGIN")?(p="spki",s=I(t.replace(/-----BEGIN.*?-----/g,"").replace(/-----END.*?-----/g,"").replace(/\s/g,""))):s=d(t);let m=await crypto.subtle.importKey(p,s,r,!1,["verify"]);return await crypto.subtle.verify(r,m,T(n[2]),d(`${n[0]}.${n[1]}`))}l.verify=x;function y(i){return{header:k(i.split(".")[0].replace(/-/g,"+").replace(/_/g,"/")),payload:k(i.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"))}}l.decode=y;l.default={sign:_,verify:x,decode:y}});var W={};B(W,{ApnsClient:()=>v,Errors:()=>b,Host:()=>D,Notification:()=>c,Priority:()=>u,PushType:()=>h,SilentNotification:()=>S});module.exports=$(W);var C=J(P()),R=require("events");var b=(o=>(o.badCertificate="BadCertificate",o.badCertificateEnvironment="BadCertificateEnvironment",o.badCollapseId="BadCollapseId",o.badDeviceToken="BadDeviceToken",o.badExpirationDate="BadExpirationDate",o.badMessageId="BadMessageId",o.badPath="BadPath",o.badPriority="BadPriority",o.badTopic="BadTopic",o.deviceTokenNotForTopic="DeviceTokenNotForTopic",o.duplicateHeaders="DuplicateHeaders",o.error="Error",o.expiredProviderToken="ExpiredProviderToken",o.forbidden="Forbidden",o.idleTimeout="IdleTimeout",o.internalServerError="InternalServerError",o.invalidProviderToken="InvalidProviderToken",o.invalidPushType="InvalidPushType",o.invalidSigningKey="InvalidSigningKey",o.methodNotAllowed="MethodNotAllowed",o.missingDeviceToken="MissingDeviceToken",o.missingProviderToken="MissingProviderToken",o.missingTopic="MissingTopic",o.payloadEmpty="PayloadEmpty",o.payloadTooLarge="PayloadTooLarge",o.serviceUnavailable="ServiceUnavailable",o.shutdown="Shutdown",o.tooManyProviderTokenUpdates="TooManyProviderTokenUpdates",o.tooManyRequests="TooManyRequests",o.topicDisallowed="TopicDisallowed",o.unknownError="UnknownError",o.unregistered="Unregistered",o))(b||{});var F=3,N="ES256",G=55*60*1e3,D=(e=>(e.production="api.push.apple.com",e.development="api.sandbox.push.apple.com",e))(D||{}),v=class extends R.EventEmitter{constructor(e){super();this.team=e.team,this.keyId=e.keyId,this.signingKey=e.signingKey,this.defaultTopic=e.defaultTopic,this.host=e.host??"api.push.apple.com",this._token=null,this.on("ExpiredProviderToken",()=>this._resetSigningToken())}send(e){return this._send(e)}sendMany(e){let n=e.map(r=>this._send(r).catch(a=>({error:a})));return Promise.all(n)}async _send(e){let n=encodeURIComponent(e.deviceToken),r=`https://${this.host}/${F}/device/${n}`,a=new Headers;a.set("authorization",`bearer ${await this._getSigningToken()}`),a.set("apns-push-type",e.pushType),a.set("apns-priority",e.priority.toString()),(e.options.topic||this.defaultTopic)&&a.set("apns-topic",e.options.topic??this.defaultTopic),e.options.expiration&&a.set("apns-expiration",typeof e.options.expiration=="number"?e.options.expiration.toFixed(0):(e.options.expiration.getTime()/1e3).toFixed(0)),e.options.collapseId&&a.set("apns-collapse-id",e.options.collapseId);let p={method:"POST",headers:a,body:JSON.stringify(e.buildApnsOptions())},s=await fetch(r,p);return this._handleServerResponse(s,e)}async _handleServerResponse(e,n){if(e.status===200)return n;let r;try{r=await e.json()}catch{r={reason:"UnknownError"}}throw r.statusCode=e.status,r.notification=n,this.emit(r.reason,r),this.emit("Error",r),r}async _getSigningToken(){if(this._token&&Date.now()-this._token.timestamp<G)return this._token.value;let e={iss:this.team,iat:Math.floor(Date.now()/1e3)},n=await(0,C.sign)(e,this.signingKey,{algorithm:N,header:{algorithm:N,kid:this.keyId}});return this._token={value:n,timestamp:Date.now()},n}_resetSigningToken(){this._token=null}};var h=(s=>(s.alert="alert",s.background="background",s.voip="voip",s.complication="complication",s.fileprovider="fileprovider",s.mdm="mdm",s.liveactivity="liveactivity",s))(h||{});var u=(e=>(e[e.immediate=10]="immediate",e[e.throttled=5]="throttled",e))(u||{});var c=class{constructor(t,e){this.deviceToken=t,this.options=e??{}}get pushType(){return this.options.type??"alert"}get priority(){return this.options.priority??10}buildApnsOptions(){let t={aps:this.options.aps??{}};this.options.alert&&(t.aps.alert=this.options.alert),typeof this.options.contentAvailable=="boolean"&&(t.aps["content-available"]=1),(typeof this.options.sound=="string"||typeof this.options.sound=="object")&&(t.aps.sound=this.options.sound),typeof this.options.category=="string"&&(t.aps.category=this.options.category),typeof this.options.badge=="number"&&(t.aps.badge=this.options.badge),typeof this.options.threadId=="string"&&(t.aps["thread-id"]=this.options.threadId);for(let e in this.options.data)t[e]=this.options.data[e];return t}};var S=class extends c{constructor(t,e={}){super(t,{contentAvailable:!0,type:"background",priority:5,...e})}};0&&(module.exports={ApnsClient,Errors,Host,Notification,Priority,PushType,SilentNotification});
